<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="X-icon" href="Logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الطريق إلى الأفضل</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        :root {
            --main: #1A202C;
            --primary: #7AB3EF;
            --half: #2A5C82;
            --secondary: #FFB74D;
            --catagorieColor: #f4f4f4;
            --background: #2D3748;
            --text: #E2E8F0;
            --card-bg: #2D3748;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --bt: #2A5C82;      
        }

        [data-theme="dark"] {            
            --main: #F8F9FA;
            --primary: #2A5C82;
            --half: #7AB3EF;
            --secondary: #FFA726;
            --background: #F8F9FA;
            --text: #091c3d;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --bt: #7AB3EF;
        }

        body {
            background: var(--main);
            color: var(--text);
            transition: 0.3s all;
            min-height: 100vh;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            position: relative;
            background: linear-gradient(90deg, var(--half), var(--secondary));
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            transition: font-size 0.3s ease;
            padding: 0 150px;
        }

        /* Button Container - Keep horizontal on all screens */
        .button-container {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transition: all 0.3s ease;
            flex-direction: row;
            flex-wrap: nowrap;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 800;
            font-size: 15px;
            border-radius: 2rem;
            cursor: pointer;
            transition: 0.3s all;
            overflow: visible;
            flex-shrink: 0;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
        }

        .theme-icon {
            width: 25px;
            height: 25px;
            display: block;
        }

        .Points {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #ff7e29;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: 0.3s all;
            text-decoration: none;
            font-weight: 800;
            font-size: 15px;
            flex-shrink: 0;
        }

        .Points:hover {
            transform: translateY(-2px);
            background: #FF9800;
        }

        .points-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        #clearStorageBtn {
            background-color: #091c3d00;
            color: #091c3d00;
            pointer-events: none;
            border-color: #091c3d00;
        }

        /* Category Header - Fix arrow alignment */
        .category {
            background: var(--card-bg);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .category:hover {
            transform: translateY(-3px);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            background: var(--primary);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            transition: all 0.3s ease;
            flex-wrap: nowrap;
        }

        .category-header .arrow {
            transition: transform 0.3s ease-in-out;
            margin-left: 10px;
            display: inline-block;
            flex-shrink: 0;
        }

        .category-header.active .arrow {
            transform: rotate(90deg);
        }

        .delete-category-btn {
            background: #E53E3E;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .delete-category-btn:hover {
            background: #C53030;
        }

        .edit-category-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .edit-category-btn:hover {
            background: #FF9800;
        }

        .category-videos {
            display: none;
            padding: 1rem;
        }

        .category-videos.active {
            display: block;
        }

        .add-video {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            background-color: var(--primary);
            border-radius: 1rem;
            height: 180px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
        }

        .add-video:hover {
            background: var(--half);
            transform: translateY(-5px);
        }

        .add-video-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .add-video .plus-sign {
            font-size: 2.5rem;
        }

        .add-video .add-text {
            font-size: 1rem;
            color: white;
        }

        .add-category {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            background: var(--secondary);
            border-radius: 1rem;
            height: 100px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 1.5rem;
        }

        .add-category:hover {
            background: #FF9800;
            transform: translateY(-5px);
        }

        .add-category-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .add-category .plus-sign {
            font-size: 2.5rem;
        }

        .add-category .add-text {
            font-size: 1rem;
            color: white;
        }

        .videos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            transition: opacity 0.3s ease-in-out;
        }

        .video {
            background: var(--card-bg);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .video:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .video iframe {
            width: 100%;
            height: 180px;
            border: none;
            transition: height 0.3s ease;
        }

        .video-title {
            padding: 1rem;
            text-align: center;
            background: var(--background);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .video-buttons {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        .video-buttons button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: 0.3s all;
        }

        .video-buttons .edit-btn {
            background: var(--secondary);
            color: white;
        }

        .video-buttons .remove-btn {
            background: #E53E3E;
            color: white;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .pagination-controls button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .pagination-controls button:hover {
            background: var(--half);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .pagination-controls button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pagination-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .modal input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 2px solid var(--primary);
            color: var(--catagorieColor);
            border-radius: 0.5rem;
            background: transparent;
            transition: all 0.3s ease;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .modal button {
            flex: 1;
            padding: 0.75rem;
            font-size: 1rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .modal button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #add-edit-video {
            background: var(--primary);
            color: white;
        }

        #add-edit-video:hover {
            background: #1E4A6E;
        }

        #cancel-btn {
            background: #E53E3E;
            color: white;
        }

        #cancel-btn:hover {
            background: #C53030;
        }

        footer {
            background: var(--main);
            color: var(--text);
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }

        /* Popup styling */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(0);
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
            backdrop-filter: blur(5px);
        }

        .popup-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow);
            color: var(--text);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .popup-overlay.active .popup-content {
            transform: scale(1);
            opacity: 1;
        }

        .popup-content h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .popup-content p {
            margin: 1rem 0;
            font-size: 1rem;
            color: var(--text);
            background-color: transparent;
        }

        .close-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--secondary);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 2rem;
            font-size: 1rem;
            transition: 0.3s all;
            text-decoration: none;
        }

        .close-btn:hover {
            background: #FF9800;
            transform: translateY(-2px);
        }

        .close-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        /* Responsive Design - Keep buttons horizontal */
        @media (max-width: 1200px) {
            .container {
                padding: 2rem;
            }

            .videos {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 992px) {
            header h1 {
                font-size: 2.2rem;
                padding: 0 140px;
            }

            .video iframe,
            .add-video {
                height: 160px;
            }

            .category-header {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
                padding: 0 130px;
            }

            .button-container {
                top: 15px;
                left: 15px;
                gap: 8px;
            }

            .theme-toggle,
            .Points {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .videos {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }

            .video iframe,
            .add-video {
                height: 140px;
            }

            .modal-content {
                width: 85%;
            }

            .category-header>span {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 1.5rem;
            }

            header h1 {
                font-size: 1.8rem;
                padding: 0 120px;
            }

            .button-container {
                gap: 6px;
                top: 10px;
                left: 10px;
            }

            .theme-toggle,
            .Points {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }

            .videos {
                grid-template-columns: 1fr;
            }

            .video iframe,
            .add-video {
                height: 120px;
            }

            .video-title {
                font-size: 0.9rem;
            }

            .video-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .video-buttons button {
                width: 100%;
            }

            .popup-content {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.6rem;
                padding: 0 110px;
            }

            .button-container {
                gap: 5px;
            }

            .theme-toggle,
            .Points {
                padding: 0.4rem 0.7rem;
                font-size: 0.7rem;
            }

            .video iframe,
            .add-video {
                height: 100px;
            }

            .modal-content {
                padding: 1rem;
            }

            .modal input {
                padding: 0.6rem;
            }

            .modal button {
                padding: 0.6rem;
                font-size: 0.9rem;
            }

            .category-header {
                font-size: 1rem;
                padding: 0.8rem;
            }

            .delete-category-btn,
            .edit-category-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                margin-left: 5px;
            }
        }

        @media (max-width: 360px) {
            header h1 {
                font-size: 1.5rem;
                padding: 0 100px;
            }

            .container {
                padding: 1rem;
            }

            .video iframe,
            .add-video {
                height: 90px;
            }

            .video-title {
                font-size: 0.8rem;
                padding: 0.8rem;
            }

            .popup-content {
                padding: 1rem;
            }

            .popup-content h2 {
                font-size: 1.2rem;
            }

            .popup-content p {
                font-size: 0.9rem;
            }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 0.5rem 0;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .video iframe,
            .add-video {
                height: 100px;
            }

            .container {
                padding: 1rem;
            }

            .category {
                margin-bottom: 1rem;
            }
        }

        /* High DPI devices */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {

            .theme-icon,
            .points-icon,
            .close-icon {
                background-size: contain;
                background-repeat: no-repeat;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .button-container,
            .add-video,
            .add-category,
            .video-buttons,
            footer {
                display: none !important;
            }

            .category {
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 1.5rem;
            }

            .video {
                page-break-inside: avoid;
            }

            .video-title {
                background: white !important;
                color: black !important;
            }
        }

        h1 {
            color: #ffffff00;
        }
    </style>
</head>

<body>
    <div class="button-container">
        <div class="popup-overlay" id="popup">
            <div class="popup-content">
                <h2>لماذا الدعم ؟</h2>
                <p>- 40% سأستخدمها في طلب العلم وكل ما يساعدني على الدعوة إلى اللّه عز وجل.</p>
                <p>- 40% لدعم المواقع الدعوية المذكورة في الموقع.</p>
                <p>- 20% دعم المشاريع كبناء المساجد و طباعة القرأن الكريم...إلخ.</p>
                <a href="#" class="close-btn"> دعم <img src="paypal.png" alt="Close Icon" class="close-icon">
                </a>
            </div>
        </div>
        <button id="clearStorageBtn">Clear Storage</button>
        <a href="#" class="Points">
            للدعم
            <img src="paypal.png" alt="Points Icon" class="points-icon">
        </a>
        
    </div>

    <header>
        <h1>قوائم الفيديوهات</h1>
    </header>

    <div class="container">
        <div class="categories" id="categories-container">
            <!-- Categories will be dynamically rendered here -->
        </div>
    </div>

    <!-- Modal for adding/editing video -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modal-title">إضافة معرف الفيديو</h3>
            <input type="text" id="video-id" placeholder="أدخل رابط الفيديو" aria-label="رابط الفيديو">
            <input type="text" id="video-title" placeholder="أدخل عنوان الفيديو" aria-label="عنوان الفيديو">
            <div class="modal-buttons">
                <button id="add-edit-video">إضافة</button>
                <button id="cancel-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Modal for editing category -->
    <div class="modal" id="edit-category-modal">
        <div class="modal-content">
            <h3 id="edit-category-title">تعديل الفئة</h3>
            <input type="text" id="edit-category-name" placeholder="اسم الفئة" aria-label="اسم الفئة">
            <input type="color" id="edit-category-color" aria-label="لون الفئة">
            <div class="modal-buttons">
                <button id="save-category-btn">حفظ</button>
                <button id="cancel-edit-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding new category -->
    <div class="modal" id="add-category-modal">
        <div class="modal-content">
            <h3 id="add-category-title">إضافة فئة جديدة</h3>
            <input type="text" id="new-category-name" placeholder="اسم الفئة" aria-label="اسم الفئة">
            <input type="color" id="new-category-color" aria-label="لون الفئة" value="#2A5C82">
            <div class="modal-buttons">
                <button id="confirm-add-category-btn">إضافة</button>
                <button id="cancel-add-category-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <footer>
        <p>الطريق إلى الأفضل Copyright ©</p>
    </footer>

    <script src="../../theme.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Disable scroll restoration
            if (history.scrollRestoration) {
                history.scrollRestoration = 'manual';
            }

            // Scroll to top on page load
            window.onload = function () {
                window.scrollTo(0, 0);
            };

            const categoriesContainer = document.getElementById('categories-container');
            const modal = document.getElementById('modal');
            const addEditVideoBtn = document.getElementById('add-edit-video');
            const cancelBtn = document.getElementById('cancel-btn');
            const videoIdInput = document.getElementById('video-id');
            const videoTitleInput = document.getElementById('video-title');
            const modalTitle = document.getElementById('modal-title');
            const clearStorageBtn = document.getElementById('clearStorageBtn');
            const editCategoryModal = document.getElementById('edit-category-modal');
            const editCategoryNameInput = document.getElementById('edit-category-name');
            const editCategoryColorInput = document.getElementById('edit-category-color');
            const saveCategoryBtn = document.getElementById('save-category-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            const popup = document.getElementById('popup');
            const addCategoryModal = document.getElementById('add-category-modal');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const newCategoryColorInput = document.getElementById('new-category-color');
            const confirmAddCategoryBtn = document.getElementById('confirm-add-category-btn');
            const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');

            let editVideoIndex = null;
            let editCategoryIndex = null;
            let categories = JSON.parse(localStorage.getItem('categories')) || [];

            // Initialize with a default category if none exists
            if (categories.length === 0) {
                categories.push({
                    name: "طلب العلم",
                    videos: [],
                    expanded: true,
                    color: "#2A5C82"
                });
                saveToLocalStorage();
            } else {
                // Ensure only one category is expanded
                const expandedCount = categories.filter(cat => cat.expanded).length;
                if (expandedCount !== 1) {
                    const firstExpandedIndex = categories.findIndex(cat => cat.expanded);
                    categories.forEach((cat, index) => {
                        cat.expanded = (index === (firstExpandedIndex !== -1 ? firstExpandedIndex : 0));
                    });
                    saveToLocalStorage();
                }
            }

            // Pagination variables
            const videosPerPage = 9;
            let currentPage = {};

            // Initialize currentPage for each category
            categories.forEach((_, index) => {
                currentPage[index] = 0;
            });

            // Improved smooth scrolling function
            function smoothScrollToElement(element, offset = 20) {
                if (!element) return;

                const elementPosition = element.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }

            // Save to Local Storage
            function saveToLocalStorage() {
                localStorage.setItem('categories', JSON.stringify(categories));
            }

            // Scroll to a specific video
            function scrollToVideo(categoryIndex, videoIndex) {
                const page = Math.floor(videoIndex / videosPerPage);
                currentPage[categoryIndex] = page;

                renderCategories();

                setTimeout(() => {
                    const videoElement = document.querySelector(`.video[data-category-index="${categoryIndex}"][data-video-index="${videoIndex}"]`);
                    if (videoElement) {
                        smoothScrollToElement(videoElement, 100);
                    }
                }, 350);
            }

            // Render Categories with Pagination
            function renderCategories() {
                categoriesContainer.innerHTML = '';

                // Show all categories
                const visibleCategories = [...categories];

                visibleCategories.forEach((category, categoryIndex) => {
                    const categoryElement = `
                <div class="category">
                    <div class="category-header" id="category-${categoryIndex}" data-index="${categoryIndex}" style="background-color: ${category.color || 'var(--primary)'};">
                        <span>${category.name}</span>
                        <div>
                            <button class="edit-category-btn">تعديل الفئة</button>
                            <button class="delete-category-btn">حذف الفئة</button>
                            <span class="arrow">${category.expanded ? '▼' : '▶'}</span>
                        </div>
                    </div>
                    <div class="category-videos ${category.expanded ? 'active' : ''}">
                        <div class="videos" id="videos-container-${categoryIndex}"></div>
                        ${category.videos.length > videosPerPage ? `
                        <div class="pagination-controls">
                            <button class="prev-page-btn" data-category-index="${categoryIndex}">السابق</button>
                            <button class="next-page-btn" data-category-index="${categoryIndex}">التالي</button>
                        </div>
                        ` : ''}
                        <div class="add-video" data-category-index="${categoryIndex}">
                            <div class="add-video-content">
                                <span class="plus-sign">+</span>
                                <span class="add-text">إضافة فيديو</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    categoriesContainer.insertAdjacentHTML('beforeend', categoryElement);

                    // Render videos for this category if it's expanded
                    if (category.expanded) {
                        renderVideos(categoryIndex);
                    }
                });

                // Add "Add Category" button at the end
                const addCategoryBtn = document.createElement('div');
                addCategoryBtn.className = 'add-category';
                addCategoryBtn.innerHTML = `
            <div class="add-category-content">
                <span class="plus-sign">+</span>
                <span class="add-text">إضافة قائمة</span>
            </div>
        `;
                addCategoryBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    addCategoryModal.style.display = 'flex';
                    newCategoryNameInput.value = '';
                    newCategoryColorInput.value = '#2A5C82';
                    setTimeout(() => newCategoryNameInput.focus(), 100);
                });
                categoriesContainer.appendChild(addCategoryBtn);

                // Rebind all event listeners
                bindEventListeners();
            }

            // Function to rebind all event listeners
            function bindEventListeners() {
                // Category headers
                document.querySelectorAll('.category-header').forEach(header => {
                    header.addEventListener('click', function (e) {
                        // Don't trigger if the click was on a button inside the header
                        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                            return;
                        }

                        const categoryIndex = parseInt(this.getAttribute('data-index'));
                        const wasExpanded = categories[categoryIndex].expanded;

                        categories.forEach((cat, index) => {
                            cat.expanded = (index === categoryIndex) ? !cat.expanded : false;
                        });
                        saveToLocalStorage();
                        renderCategories();

                        if (!wasExpanded) {
                            setTimeout(() => {
                                const headerElement = document.getElementById(`category-${categoryIndex}`);
                                smoothScrollToElement(headerElement);
                            }, 50);
                        }
                    });
                });

                // Delete category buttons
                document.querySelectorAll('.delete-category-btn').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const categoryIndex = parseInt(this.closest('.category-header').getAttribute('data-index'));
                        if (confirm("هل أنت متأكد من رغبتك في حذف هذه الفئة؟")) {
                            categories.splice(categoryIndex, 1);
                            saveToLocalStorage();
                            renderCategories();
                        }
                    });
                });

                // Edit category buttons
                document.querySelectorAll('.edit-category-btn').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const categoryIndex = parseInt(this.closest('.category-header').getAttribute('data-index'));
                        const category = categories[categoryIndex];
                        editCategoryNameInput.value = category.name;
                        editCategoryColorInput.value = category.color || '#2A5C82';
                        editCategoryModal.style.display = 'flex';
                        editCategoryIndex = categoryIndex;
                    });
                });

                // Add video buttons - Modified to prevent event propagation
                document.querySelectorAll('.add-video').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const categoryIndex = parseInt(this.getAttribute('data-category-index'));

                        // Don't expand/collapse the category here
                        modal.style.display = 'flex';
                        modalTitle.textContent = 'إضافة معرف الفيديو';
                        videoIdInput.value = '';
                        videoTitleInput.value = '';
                        editVideoIndex = null;
                        editCategoryIndex = categoryIndex;
                        videoIdInput.focus();
                    });
                });

                // Pagination buttons
                document.querySelectorAll('.prev-page-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const categoryIndex = parseInt(this.getAttribute('data-category-index'));
                        currentPage[categoryIndex] = Math.max(0, currentPage[categoryIndex] - 1);
                        renderVideos(categoryIndex);

                        setTimeout(() => {
                            const headerElement = document.getElementById(`category-${categoryIndex}`);
                            smoothScrollToElement(headerElement);
                        }, 100);
                    });
                });

                document.querySelectorAll('.next-page-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const categoryIndex = parseInt(this.getAttribute('data-category-index'));
                        const totalPages = Math.ceil(categories[categoryIndex].videos.length / videosPerPage);
                        currentPage[categoryIndex] = Math.min(totalPages - 1, currentPage[categoryIndex] + 1);
                        renderVideos(categoryIndex);

                        setTimeout(() => {
                            const headerElement = document.getElementById(`category-${categoryIndex}`);
                            smoothScrollToElement(headerElement);
                        }, 100);
                    });
                });
            }

            // Render videos for a specific category and page
            function renderVideos(categoryIndex) {
                const category = categories[categoryIndex];
                const start = currentPage[categoryIndex] * videosPerPage;
                const end = start + videosPerPage;
                const videosToRender = category.videos.slice(start, end);

                const videosContainer = document.getElementById(`videos-container-${categoryIndex}`);
                videosContainer.style.opacity = '0';

                setTimeout(() => {
                    if (videosToRender.length === 0 && currentPage[categoryIndex] > 0) {
                        currentPage[categoryIndex] -= 1;
                        renderVideos(categoryIndex);
                        return;
                    }

                    videosContainer.innerHTML = videosToRender.map((video, videoIndex) => `
                <div class="video" data-category-index="${categoryIndex}" data-video-index="${start + videoIndex}">
                    <iframe data-src="https://www.youtube.com/embed/${video.id}" allowfullscreen></iframe>
                    <div class="video-title">${video.title}</div>
                    <div class="video-buttons">
                        <button class="edit-btn" data-category-index="${categoryIndex}" data-video-index="${start + videoIndex}">تعديل</button>
                        <button class="remove-btn" data-category-index="${categoryIndex}" data-video-index="${start + videoIndex}">حذف</button>
                    </div>
                </div>
            `).join('');

                    videosContainer.style.opacity = '1';

                    // Lazy load videos
                    const lazyVideos = videosContainer.querySelectorAll('.video iframe');
                    const lazyVideoObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const iframe = entry.target;
                                iframe.src = iframe.dataset.src;
                                lazyVideoObserver.unobserve(iframe);
                            }
                        });
                    });

                    lazyVideos.forEach(video => {
                        lazyVideoObserver.observe(video);
                    });

                    // Add event listeners for Edit and Delete buttons
                    videosContainer.querySelectorAll('.edit-btn').forEach(editBtn => {
                        editBtn.addEventListener('click', function () {
                            const categoryIndex = parseInt(this.getAttribute('data-category-index'));
                            const videoIndex = parseInt(this.getAttribute('data-video-index'));
                            const video = categories[categoryIndex].videos[videoIndex];

                            modal.style.display = 'flex';
                            modalTitle.textContent = 'تعديل الفيديو';
                            videoIdInput.value = `https://www.youtube.com/watch?v=${video.id}`;
                            videoTitleInput.value = video.title;
                            editVideoIndex = videoIndex;
                            editCategoryIndex = categoryIndex;
                        });
                    });

                    videosContainer.querySelectorAll('.remove-btn').forEach(removeBtn => {
                        removeBtn.addEventListener('click', function () {
                            const categoryIndex = parseInt(this.getAttribute('data-category-index'));
                            const videoIndex = parseInt(this.getAttribute('data-video-index'));

                            if (confirm("هل أنت متأكد من رغبتك في حذف هذا الفيديو؟")) {
                                categories[categoryIndex].videos.splice(videoIndex, 1);
                                saveToLocalStorage();

                                if (categories[categoryIndex].videos.length === 0) {
                                    if (categoryIndex !== 0 || categories[0].name !== "طلب العلم") {
                                        categories.splice(categoryIndex, 1);
                                    }
                                    renderCategories();
                                } else {
                                    renderVideos(categoryIndex);
                                }
                            }
                        });
                    });

                    // Update pagination buttons
                    const prevButton = document.querySelector(`.prev-page-btn[data-category-index="${categoryIndex}"]`);
                    const nextButton = document.querySelector(`.next-page-btn[data-category-index="${categoryIndex}"]`);

                    if (prevButton && nextButton) {
                        prevButton.disabled = currentPage[categoryIndex] === 0;
                        nextButton.disabled = end >= category.videos.length;
                    }

                }, 300);
            }

            // Extract YouTube Video ID from URL
            function extractVideoId(url) {
                if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
                const patterns = [
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i,
                    /(?:youtube\.com\/shorts\/)([^"&?\/\s]{11})/i
                ];
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) return match[1];
                }
                return null;
            }

            // Add/Edit Video
            addEditVideoBtn.addEventListener('click', () => {
                const videoUrl = videoIdInput.value.trim();
                const videoTitle = videoTitleInput.value.trim();
                const videoId = extractVideoId(videoUrl);

                if (!videoId || videoId.length !== 11) {
                    alert('يرجى إدخال رابط فيديو يوتيوب صالح.');
                    return;
                }
                if (!videoTitle) {
                    alert('يرجى إدخال عنوان الفيديو.');
                    return;
                }

                let videoIndex;
                if (editVideoIndex === null) {
                    // Adding a new video
                    categories[editCategoryIndex].videos.push({ id: videoId, title: videoTitle });
                    videoIndex = categories[editCategoryIndex].videos.length - 1;
                } else {
                    // Editing existing video
                    categories[editCategoryIndex].videos[editVideoIndex] = { id: videoId, title: videoTitle };
                    videoIndex = editVideoIndex;
                }

                if (categories[editCategoryIndex].videos.length > videosPerPage) {
                    const totalPages = Math.ceil(categories[editCategoryIndex].videos.length / videosPerPage);
                    currentPage[editCategoryIndex] = totalPages - 1;
                }

                saveToLocalStorage();
                renderCategories();
                modal.style.display = 'none';

                // Scroll to the newly added/edited video
                setTimeout(() => {
                    scrollToVideo(editCategoryIndex, videoIndex);
                }, 300);
            });

            // Cancel Button
            cancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // Save Category Changes
            saveCategoryBtn.addEventListener('click', () => {
                const newName = editCategoryNameInput.value.trim();
                const newColor = editCategoryColorInput.value;

                if (newName) {
                    categories[editCategoryIndex].name = newName;
                    categories[editCategoryIndex].color = newColor;
                    saveToLocalStorage();
                    renderCategories();
                    editCategoryModal.style.display = 'none';

                    // Scroll to the edited category
                    setTimeout(() => {
                        const headerElement = document.getElementById(`category-${editCategoryIndex}`);
                        smoothScrollToElement(headerElement);
                    }, 100);
                } else {
                    alert('يرجى إدخال اسم الفئة.');
                }
            });

            // Cancel Editing Category
            cancelEditBtn.addEventListener('click', () => {
                editCategoryModal.style.display = 'none';
            });

            // Add New Category
            confirmAddCategoryBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const newName = newCategoryNameInput.value.trim();
                const newColor = newCategoryColorInput.value;

                if (!newName) {
                    alert('يرجى إدخال اسم الفئة.');
                    return;
                }

                if (categories.some(cat => cat.name === newName)) {
                    alert('هذه الفئة موجودة بالفعل!');
                    return;
                }

                const newCategory = {
                    name: newName,
                    videos: [],
                    expanded: true,
                    color: newColor
                };

                categories.push(newCategory);
                categories.forEach((cat, index) => {
                    cat.expanded = (index === categories.length - 1);
                });

                currentPage[categories.length - 1] = 0;
                saveToLocalStorage();
                renderCategories();
                addCategoryModal.style.display = 'none';
                newCategoryNameInput.value = '';

                // Scroll to the new category
                setTimeout(() => {
                    const headerElement = document.getElementById(`category-${categories.length - 1}`);
                    smoothScrollToElement(headerElement);
                }, 100);
            });

            // Cancel Adding New Category
            cancelAddCategoryBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                addCategoryModal.style.display = 'none';
            });

            // Clear Local Storage
            clearStorageBtn.addEventListener('click', () => {
                if (confirm("هل أنت متأكد من رغبتك في حذف جميع البيانات؟")) {
                    localStorage.clear();
                    categories = [{
                        name: "طلب العلم",
                        videos: [],
                        expanded: true,
                        color: "#2A5C82"
                    }];
                    renderCategories();
                    alert('تم حذف جميع البيانات بنجاح.');
                }
            });

            // Close Modal on Outside Click
            const modals = [modal, editCategoryModal, addCategoryModal];
            modals.forEach(modalElement => {
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        modalElement.style.display = 'none';
                    }
                });
            });

            // Popup functionality
            function openPopup() {
                popup.classList.add("active");
            }

            function closePopup() {
                popup.classList.remove("active");
            }
            function goTolink() {
                return 'https://www.paypal.com/paypalme/YFitraAwakeningY';
            }

            popup.addEventListener("click", function (e) {
                if (e.target === this) {
                    closePopup();
                }
            });

            document.querySelector('.close-btn').addEventListener('click', function (e) {
                const shortsUrl = goTolink();
                window.open(shortsUrl, '_blank');
            });

            document.querySelector('.Points').addEventListener('click', function (e) {
                e.preventDefault();
                openPopup();
            });

            // Make Enter key work like clicking the Add button in all modals
            function setupEnterKeyBehavior() {
                videoIdInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addEditVideoBtn.click();
                    }
                });

                videoTitleInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addEditVideoBtn.click();
                    }
                });

                editCategoryNameInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveCategoryBtn.click();
                    }
                });

                newCategoryNameInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmAddCategoryBtn.click();
                    }
                });
            }

            // Initial setup
            setupEnterKeyBehavior();
            renderCategories();
        });
    </script>
</body>

</html>
